$(function(){var s=$(window),z=$("body"),w=z.add("html"),m=$("#content"),G=m.find("section"),h=$("#mock-scroller"),n=0,F=["opacity","left","top","width","height","background-position"],o=location.hash,t=!~location.href.indexOf("noanims"),g=[],f=document.body.style.webkitTransform!==undefined,u=document.body.style.MozTransform!==undefined,H=document.body.style.msTransform!==undefined,D,A,a,B,y,K,k,r,v;G.each(function(L){var M=G.eq(L);M.data("$pNodes",M.find(".animate"));M.data("bSection",true);M.add(M.data("$pNodes")).each(function(){var N=$(this),O=N.data();O.iPause=0|N.attr("anim-pause");O.bDetached=!!~"1 true".indexOf(N.attr("anim-detached"));O.fSpeed=parseFloat(N.attr("anim-speed"))||1;O.onFocus=N.attr("anim-focus-handler");O.onBlur=N.attr("anim-blur-handler")});M.detach()});function x(O,N,P){var M=/(-?\d+)(.*)/.exec(O),Q=parseFloat(M[1]),L=M[2];switch(L){case"":case"px":return Q;case"%":return N[P]()*Q/100;default:throw new Error("Unexpected unit type: "+L);return}}function E(N,R){var M={},P,L,Q,O;N.addClass(R).removeAttr("style");for(P=0,L=F.length;P<L;P++){O=F[P];switch(O){case"opacity":Q=0|N.css(O);break;case"left":case"top":Q=N.position()[O];break;case"width":case"height":Q=N["outer"+O.substr(0,1).toUpperCase()+O.substr(1)]();break;case"background-position":Q=(N.css(O)||"0 0").split(" ");Q[0]=x(Q[0],N,"outerWidth");Q[1]=x(Q[1],N,"outerHeight");break}M[O]=Q}N.removeClass("start focus to end");return M}function I(O,N){var M,L;if(O===N){return true}if(typeof O!==typeof N){return false}if(O.length&&O.splice&&N.length&&N.splice){if(O.length!=N.length){return false}for(M=0,L=O.length;M<L;M++){if(!I(O[M],N[M])){return false}}return true}return false}function d(O,N){var L={},P,M;for(P in N){if(!I(O[P],N[P])){L[P]=M=[O[P],N[P]]}}return M&&L}function c(Q,W,X,U){var P=["start","focus","to","end"],T=X-1,S=P[X],V=E(Q,S),O=Q.data(),N=!!U,M,R,L;if(!U){U=0}M=d(E(Q,P[T]),V);if(!M){return 0}for(R in M){L=Math.abs(M[R][1]-M[R][0]);if(!N&&(L>U)){U=L}}g.push({$node:Q,oProps:M,iTop:W,iBottom:W+U,bSection:O.bSection});return O.bDetached?0:U}function e(){var L=0,M=+new Date(),Q=G.length-1,P=0,O,N;g=window.aAnimations=[];h.css("height",10000);G.each(function(T){var S=$(this),R=S.data(),Z=R.$pNodes,X=0,Y=R.iPause,V,U,W,aa;R.startsAt=L;S.css({top:"",visibility:"hidden"}).appendTo(m);if(T){X=c(S,L,1)}for(V=0,U=Z.length;V<U;V++){aa=Z.eq(V);if(t){Y=Math.max(Y,c(aa,L,1,X),W=c(aa,L+X+Y,2,X),c(aa,L+X+Y+W,3,X))}}if(T){L+=Y}c(S,L+X,2);if(T<Q){c(S,L+X,3)}S.detach().css({visibility:"visible"});R.endsAt=L+=X;R.bVisible=false});for(i=0,l=G.length;i<l;i++){G.eq(i).data().iTop=Infinity;G.eq(i).data().iBottom=-Infinity}for(i=0,l=g.length;i<l;i++){O=g[i];if(O.iBottom>P){P=O.iBottom}if(O.bSection){N=O.$node.data();if(O.iTop<N.iTop){N.iTop=O.iTop}if(O.iBottom>N.iBottom){N.iBottom=O.iBottom}}}P=Math.max(P,++G.last().data().iBottom);h.css("height",(B=P)+A);s.trigger("animations-added",{animations:g})}function j(){var L=(y/B)||0;e();s.trigger("post-resize-anim");s.scrollTop(L*B);p();v.adjustRange(B).setPosition(L*B)}function J(M,N,L){return(M-N.iTop)/(N.iBottom-N.iTop)*(L[1]-L[0])+L[0]}function b(M,N,L){if(L[0].splice){return $.map(L[0],function(P,O){return(0|J(M,N,[L[0][O],L[1][O]]))+"px"}).join(" ")}else{return J(M,N,L)}}function C(){var L=+new Date(),Q=s.scrollTop(),P=L-K;K=L;if(k){clearTimeout(k);k=0}if((P>200)||(P<50)){p(Q)}else{var O=y,N=Q-O;function M(){var R=+new Date(),S=(R+30-L)/P;if(S>1){S=1}p(O+N*S);if(S<1){k=setTimeout(M,30)}}M()}}function p(Y){var U=false,V,T,L,P,N,O,W,Q,S,X,R,M;Y||(Y=s.scrollTop());y=Y;if(Y<0){Y=0}if(Y>B){Y=B}for(V=0,T=G.length;V<T;V++){P=G.eq(V);N=P.data();if((N.iTop<=Y)&&(N.iBottom>=(Y))){if(!N.bVisible){P.appendTo(m);N.bVisible=true}if(!U){if(a!=(W=P.attr("id").split("-").pop())){location.replace("#"+(a=W));z.prop("class",z.prop("class").replace(/(?: |^)section-[^ ]+/g,"")).addClass("section-"+W)}U=true}}else{if(N.bVisible){P.detach();N.bVisible=false}}}for(V=0,T=g.length;V<T;V++){L=g[V];O=L.$node;R=Y;if((L.iTop>R)||(L.iBottom<R)){M=L.lastState;L.lastState="disabled";if(M==="enabled"){R=(L.iTop>R)?L.iTop:L.iBottom}else{continue}}else{L.lastState="enabled"}S={};X=L.oProps;for(Q in X){S[Q]=b(R,L,X[Q])}O.css(q(S))}}function q(L){if(L.top!=null||L.left!=null){if(f){L.webkitTransform="translate3d("+(L.left||0)+"px, "+(L.top||0)+"px, 0)";if(null!=L.top){L.top=0}if(null!=L.left){L.left=0}}if(u||H){L[u?"MozTransform":"msTransform"]=(L.top?"translateY("+L.top+"px)":"")+(L.left?"translateX("+L.left+"px)":"");if(null!=L.top){L.top=0}if(null!=L.left){L.left=0}}}return L}window.getAnimationController=function(O){var N,M,L;for(M=0,L=g.length;M<L;M++){if(g[M].$node.is(O)){N=g[M];break}}if(!N){throw new Error("no animation matches selector "+O)}return{scrollTo:function(P){P+=N.iTop;P=Math.max(N.iTop,Math.min(N.iBottom,P));w.scrollTop(P)},scrollBy:function(P){P=y+P;P=Math.max(N.iTop,Math.min(N.iBottom,P));w.scrollTop(P)}}};window.scrollToSection=function(N,L){var P=G.filter("#story-"+N),O=P.data(),M=O.iTop+(G[0]===P[0]?0:A+1);if(L){w.scrollTop(M)}else{w.animate({scrollTop:M},1000)}};if(o){setTimeout(function(){scrollToSection(o.substr(1),true)},100)}v=new Kinetics(window);window.kinetics=v;v.bind("move",function(L,M){p(M)});s.bind("resize",function(){var L=s.width()+"x"+s.height();if(L===r){return}r=L;if(D){clearTimeout(D)}D=setTimeout(j,50);A=s.height()}).trigger("resize").bind("scroll",C)});